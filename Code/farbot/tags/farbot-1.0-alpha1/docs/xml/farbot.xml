<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
"http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">
<book>
  <bookinfo>
    <title>farbot: FreeBSD Automated Release 'Bot</title>

    <legalnotice>
      <para>The content of this guide is the original work of Three Rings
      Design, Inc. All rights reserved.</para>

      <para>The XML and CSS used to generate this guide is based on the work
      of Will Barton and Michael Maibaum, as contributed to the DarwinPorts
      Project under the 3 clause BSD license. Their copyright remains.</para>
    </legalnotice>

    <copyright>
      <year>2006</year>

      <holder>Three Rings Design, Inc.</holder>
    </copyright>

    <copyright>
      <year>2002</year>

      <year>2003</year>

      <year>2004</year>

      <holder>The OpenDarwin Project</holder>
    </copyright>
  </bookinfo>

  <preface>
    <title>About farbot</title>

    <para>farbot was written by Landon Fuller and Jonathan Le Plastrier for
    the purpose of automating the process of building FreeBSD Jumpstart
    [netboot] install releases. It handles the building of the releases,
    builds any packages you wish to install, configures the bootloader, and
    constructs the NFS exported directory structure needed for a netinstall,
    all from a simple configuration file. We encourage you to submit any patch
    you think would be useful. You may also join the <ulink
    url="https://dpw.threerings.net/mailman/listinfo/farbot">farbot mailing
    list</ulink>.</para>
  </preface>

  <chapter>
    <title>Installing and Using farbot</title>

    <sect1>
      <title>Installation</title>

      <sect2>
        <title>Prerequisites</title>

        <para>farbot depends on the following components:</para>

        <itemizedlist>
          <listitem>
            <simpara><ulink url="http://www.python.org/">Python
            2.4</ulink></simpara>
          </listitem>

          <listitem>
            <simpara><ulink url="???">Twisted Networking
            Framework</ulink></simpara>
          </listitem>

          <listitem>
            <simpara><ulink url="???">Zconfig</ulink></simpara>
          </listitem>

          <listitem>
            <para><ulink url="http://www.freebsd.org">FreeBSD</ulink> is
            required to actually build installations.</para>
          </listitem>
        </itemizedlist>
      </sect2>

      <sect2>
        <title>Installing with the Python Distutils</title>

        <para>farbot uses the standard Python distutils. To install, simply
        run <filename>setup.py</filename>: <programlisting>./setup.py install</programlisting></para>

        <para>The farbot library will be installed in the Python site-packages
        directory. The <filename>farbot</filename> command line tool will be
        installed in the Python-specified bin directory. An example
        configuration file, <filename>farbot.conf</filename>, is supplied with
        the source distribution.</para>
      </sect2>
    </sect1>

    <sect1>
      <title>Configuring farbot</title>

      <sect2>
        <title>Introduction</title>

        <para>The farbot configuration file is composed of five different
        section types: <itemizedlist>
            <listitem>
              <simpara>Releases Configuration</simpara>
            </listitem>

            <listitem>
              <simpara>Partitions Configuration</simpara>
            </listitem>

            <listitem>
              <simpara>PackageSets Configuration</simpara>
            </listitem>

            <listitem>
              <simpara>Installations Configuration</simpara>
            </listitem>
          </itemizedlist> The configuration uses an Apache-style syntax.
        </para>
      </sect2>

      <sect2>
        <title>Releases Configuration</title>

        <simpara>The <computeroutput>Releases</computeroutput> section defines
        at least one <computeroutput>Release</computeroutput> within a farbot
        configuration file. </simpara>

        <sect3>
          <title>Releases Configuration Options</title>

          <variablelist>
            <varlistentry>
              <term>BuildRoot</term>

              <listitem>
                <simpara>Used as the working directory for release builds. A
                per release directory is added by farbot at build
                time.</simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>InstallRoot</term>

              <listitem>
                <simpara>Installation clients will load installation data from
                this directory. This directory will end up being NFS and TFTP
                exported.</simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>NFSHost</term>

              <listitem>
                <simpara>The IP address/FQDN of the machine that will be
                acting as an NFS server for the installation files.</simpara>
              </listitem>
            </varlistentry>
          </variablelist>

          <sect4>
            <title>Release Configuration Options</title>

            <variablelist>
              <varlistentry>
                <term>&lt;Release Name&gt;</term>

                <listitem>
                  <simpara>The <computeroutput>Release</computeroutput>
                  section must be named. <remark><emphasis>ex: &lt;Release
                  6.0&gt;</emphasis></remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>CVSRoot</term>

                <listitem>
                  <simpara>The FreeBSD CVS repository mirror. <remark>ex:
                  /home/ncvs</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>CVSTag</term>

                <listitem>
                  <simpara>The CVS tag for this release. <remark>ex:
                  RELENG_6_0</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>LocalData</term>

                <listitem>
                  <simpara>Custom files to be made available at install time
                  via the NFS mout in the path
                  <filename>/dist/local</filename>.</simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>InstallCSDs</term>

                <listitem>
                  <simpara>Whether to create ISO install images.</simpara>
                </listitem>
              </varlistentry>
            </variablelist>
          </sect4>
        </sect3>
      </sect2>

      <sect2>
        <title>Partitions Configuration</title>

        <simpara>The <computeroutput>Partitions</computeroutput> section
        defines at least one <computeroutput>PartitionMap</computeroutput>
        with at least one <computeroutput>Partition</computeroutput> within a
        farbot configuration file. </simpara>

        <sect3>
          <title>PartitionMap Configuration Options</title>

          <variablelist>
            <varlistentry>
              <term>&lt;PartitionMap Name&gt;</term>

              <listitem>
                <simpara>The <computeroutput>PartitionMap</computeroutput>
                section must be named. <remark><emphasis>ex: &lt;PartitionMap
                Standard&gt;</emphasis></remark></simpara>
              </listitem>
            </varlistentry>
          </variablelist>

          <sect4>
            <title>Partition Configuration Options</title>

            <variablelist>
              <varlistentry>
                <term>Mount</term>

                <listitem>
                  <simpara>Mount point for this partition. <remark>ex:
                  /usr</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>Size</term>

                <listitem>
                  <simpara>The size of this partition. <remark>ex:
                  512MB</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>Type</term>

                <listitem>
                  <simpara>Type of filesystem. <remark>ex:
                  ufs</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>SoftUpdates</term>

                <listitem>
                  <simpara>Whether to enable soft updates on this
                  filesystem.</simpara>
                </listitem>
              </varlistentry>
            </variablelist>
          </sect4>
        </sect3>
      </sect2>

      <sect2>
        <title>PackageSets Configuration</title>

        <simpara>The <computeroutput>PackageSets</computeroutput> section
        defines at least one <computeroutput>PackageSets</computeroutput>
        within a farbot configuration file. </simpara>

        <sect3>
          <title>PackageSet Configuration Options</title>

          <variablelist>
            <varlistentry>
              <term>&lt;PackageSet Name&gt;</term>

              <listitem>
                <simpara>The <computeroutput>PackageSet</computeroutput>
                section must be named. <remark><emphasis>ex: &lt;PackageSet
                Base&gt;</emphasis></remark></simpara>
              </listitem>
            </varlistentry>
          </variablelist>

          <sect4>
            <title>Package Configuration Options</title>

            <variablelist>
              <varlistentry>
                <term>Port</term>

                <listitem>
                  <simpara>The category and name of this port. <remark>ex:
                  security/sudo</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>Package</term>

                <listitem>
                  <simpara>Optional: The package name of this port, if it
                  differs from the port name. <remark>ex:
                  mysql50-server</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>BuildOptions</term>

                <listitem>
                  <simpara>An optional list of options to pass to the package
                  build. <remark>ex:</remark></simpara>

                  <programlisting>&lt;BuildOptions&gt;
    WITH_COLLATION  latin1_general_ci
    WITH_OPTION  true
&lt;/BuildOptions&gt;</programlisting>
                </listitem>
              </varlistentry>
            </variablelist>
          </sect4>
        </sect3>
      </sect2>

      <sect2>
        <title>Installations Configuration</title>

        <simpara>The <computeroutput>Installations</computeroutput> section
        defines at least one <computeroutput>Installation</computeroutput>
        within a farbot configuration file. </simpara>

        <sect3>
          <title>Installation Configuration Options</title>

          <variablelist>
            <varlistentry>
              <term>&lt;Installation Name&gt;</term>

              <listitem>
                <simpara>The <computeroutput>Installation</computeroutput>
                section must be named. <remark><emphasis>ex: &lt;Installation
                Database&gt;</emphasis></remark></simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>Description</term>

              <listitem>
                <simpara>A human-readable description for this installation,
                used in the installation-selection boot menu generated by
                farbot.</simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>Release</term>

              <listitem>
                <simpara>A <computeroutput>Release</computeroutput> name
                defined in the <computeroutput>Releases</computeroutput>
                section above. There may only be one release per
                installation.</simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>PackageSet</term>

              <listitem>
                <simpara>A list of <computeroutput>PackageSet</computeroutput>
                names as defined in the
                <computeroutput>PackageSets</computeroutput> section.
                </simpara>
              </listitem>
            </varlistentry>

            <varlistentry>
              <term>NetworkDevice</term>

              <listitem>
                <simpara>The network device to mount the the NFS root from.
                <remark>ex: em0</remark></simpara>
              </listitem>
            </varlistentry>
          </variablelist>

          <sect4>
            <title>Disk Section Options</title>

            <variablelist>
              <varlistentry>
                <term>&lt;Disk Name&gt;</term>

                <listitem>
                  <simpara>A disk name that matches the corresponding system
                  disk for the following
                  <computeroutput>PartitionMap</computeroutput>. <remark>ex:
                  ad0</remark></simpara>
                </listitem>
              </varlistentry>

              <varlistentry>
                <term>PartitionMap</term>

                <listitem>
                  <simpara>A <computeroutput>PartitionMap</computeroutput>
                  name as defined in the
                  <computeroutput>Partitions</computeroutput> section above.
                  Only list one <computeroutput>PartitionMap</computeroutput>
                  per disk.</simpara>
                </listitem>
              </varlistentry>
            </variablelist>
          </sect4>

          <sect4>
            <title>PostInstall Section Options</title>

            <variablelist>
              <varlistentry>
                <term>Command</term>

                <listitem>
                  <simpara>A command to be run from
                  <filename>/dist/local</filename> after the installation
                  boots for the first time. See LocalData above.</simpara>
                </listitem>
              </varlistentry>
            </variablelist>
          </sect4>
        </sect3>
      </sect2>

      <sect2>
        <title>Example Configuration File</title>

        <simpara>An example configuration follows. The same configuration file
        is included with the distribution as
        <filename>farbot.conf</filename>.</simpara>

        <programlisting>#
# Releases
#
&lt;Releases&gt;
        # Release Build Working Directory
        BuildRoot       /export/freebsd/build

        # Install/NFS Directory
        # Clients will load installation data from this directory
        InstallRoot     /export/freebsd/netinstall

        # NFS/TFTP Server Host/IP
        # The host exporting the installation data.
        # Should probably be the local machine
        NFSHost         jumpstart.example.org

        &lt;Release 6.0&gt;
                # FreeBSD CVS Repository Mirror
                CVSRoot         /home/ncvs
                # Release Tag
                CVSTag          RELENG_6_0

                # LocalData will be copied into the release
                # distribution. These files will be available at
                # install time via the NFS mount, in the path /dist/local
                LocalData       /export/freebsd/postinst

                # Enable creation of ISO install images
                # Requires cdrtools
                InstallCDs      True
        &lt;/Release&gt;

        &lt;Release 6-STABLE&gt;
                # FreeBSD CVS Repository Mirror
                CVSRoot /home/ncvs
                # Release Tag
                CVSTag  RELENG_6
        &lt;/Release&gt;
&lt;/Releases&gt;

#
# Partition Maps
#
&lt;Partitions&gt;
        &lt;PartitionMap Standard&gt;
                &lt;Partition 1&gt;
                        Mount           /
                        Size            512MB
                        Type            ufs
                        SoftUpdates     no
                &lt;/Partition&gt;

                &lt;Partition 2&gt;
                        Size            4GB
                        Type            swap
                &lt;/Partition&gt;

                &lt;Partition 3&gt;
                        Mount           /var
                        Size            10GB
                        Type            ufs
                &lt;/Partition&gt;

                &lt;Partition 4&gt;
                        Mount           /tmp
                        Size            1GB
                        Type            ufs
                &lt;/Partition&gt;

                &lt;Partition 5&gt;
                        # All remaining space
                        Mount           /usr
                        Size            0GB
                        Type            ufs
                &lt;/Partition&gt;
        &lt;/PartitionMap&gt;
&lt;/Partitions&gt;

#
# Package Sets
#
&lt;PackageSets&gt;
        &lt;PackageSet Base&gt;
                &lt;Package&gt;
                        Port            security/sudo
                &lt;/Package&gt;
        &lt;/PackageSet&gt;
        &lt;PackageSet Database&gt;
                &lt;Package&gt;
                        Port            databases/mysql50-server
                        # If your build options modify the name
                        # of the resulting package, use the Package
                        # option to define the correct name.
                        #Package                mysql50-server
                        &lt;BuildOptions&gt;
                                WITH_COLLATION  latin1_general_ci
                        &lt;/BuildOptions&gt;
                &lt;/Package&gt;
        &lt;/PackageSet&gt;
&lt;/PackageSets&gt;


#
# Installation Types
#
&lt;Installations&gt;
        &lt;Installation Standard&gt;
                # Human-readable Description.
                # Used in the installation-selection boot menu
                Description     Standard Installation
                Release         6.0
                PackageSet      Base
                PackageSet      Database
                NetworkDevice   em0
                &lt;Disk ad0&gt;
                        PartitionMap    Standard
                &lt;/Disk&gt;
                &lt;PostInstall&gt;
                        Command /dist/local/postinst/local.sh database
                        Command /dist/local/postinst/cleanup.sh everything
                &lt;/PostInstall&gt;
        &lt;/Installation&gt;
&lt;/Installations&gt;
                </programlisting>
      </sect2>
    </sect1>

    <sect1>
      <title>Running farbot</title>

      <simpara>List a number of command line examples</simpara>
    </sect1>
  </chapter>

  <chapter>
    <title>Installing FreeBSD using farbot </title>

    <sect1>
      <title>Introduction</title>

      <simpara>Go through an example installation, showing a screen shot of
      the bootloader and explaining where errors could occur, possibly a FAQ
      of common errors.</simpara>
    </sect1>
  </chapter>
</book>